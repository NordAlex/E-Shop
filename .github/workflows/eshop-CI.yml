name: Eshop-CI

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
    tests:
      name: Run tests
      runs-on: ubuntu-latest

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: 8.0.x
            
        - name: Setup .NET 6 (for net6.0 tests)
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: 6.0.x

        - name: Restore dependencies
          run: dotnet restore
        
        - name: Build
          run: dotnet build

        - name: Test
          shell: bash
          run: |
              set -e
              for proj in $(find . -name '*Tests.csproj' -o -name '*Test.csproj'); do
                dotnet restore "$proj"
                dotnet build "$proj" --configuration Release --no-restore
                dotnet test "$proj" --configuration Release --no-build --verbosity normal
                echo "Testing $proj"
              done

    build-images:
      name: Build Docker images
      needs: tests  
      runs-on: ubuntu-latest    
      permissions:
        contents: read
        packages: write

      strategy:
        matrix:
          service:
            - { name: carting,  dockerfile: Eshop.Carting/EShop.Carting.WebApi/Dockerfile,  context: Eshop.Carting }
            - { name: catalog,  dockerfile: Eshop.Catalog/EShop.Catalog.WebApi/Dockerfile,  context:  Eshop.Catalog }
            - { name: identity, dockerfile: Identity/Dockerfile,      context: Identity }
            - { name: gateway,  dockerfile: Ocelot.Gateway/Dockerfile, context: Ocelot.Gateway }  

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Convert owner to lowercase
          id: repo
          run: echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

        - name: Login to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build & push
          uses: docker/build-push-action@v6
          with:
            context: ${{ matrix.service.context }}
            file: ${{ matrix.service.dockerfile }}
            push: true
            tags: |
              ghcr.io/${{ steps.repo.outputs.owner }}/e-shop/${{ matrix.service.name }}:sha-${{ github.sha }}
              ghcr.io/${{ steps.repo.outputs.owner }}/e-shop/${{ matrix.service.name }}:latest